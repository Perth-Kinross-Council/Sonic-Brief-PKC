@page "/uploads/{RecordingId:guid}/analysis"
@using Servent.SrsWales.SocialCare.App.Data
@using Servent.SrsWales.SocialCare.App.Services
@using Servent.SrsWales.SocialCare.App.Services.SonicBrief
@using Servent.SrsWales.SocialCare.App.Services.SonicBrief.Models
@using Markdig;

@inject StorageService StorageService
@inject NavigationManager NavigationManager

<div class="flex flex-col gap-5 p-5">

	<div class="flex justify-between gap-2 items-center">
		<div class="text-lg font-medium">
			Case: @Recording?.CaseId
		</div>
		<RadzenButton Click="Close" Icon="close" Variant="Variant.Text" ButtonStyle="ButtonStyle.Dark" class="!rounded-full" />
	</div>

	<div class="h-px px-5 bg-gray-200 w-full"></div>


	@if (!string.IsNullOrWhiteSpace(Recording?.AnalysisText))
	{
		<div class="markdown">@((MarkupString)Markdown.ToHtml(Recording.AnalysisText))</div>
	} else
	{
		<div class="p-5 text-center text-gray-400 mt-16 font-medium">No analysis available.</div>
	}
</div>

@code {
	[Parameter]
	public Guid RecordingId { get; set; }

	private bool IsLoading { get; set; } = false;
	private Recording? Recording { get; set; } = null;

	protected override async Task OnInitializedAsync()
	{
		await GetInitialData();

		await base.OnInitializedAsync();
	}
	private async Task GetInitialData()
	{
		IsLoading = true;
		StateHasChanged();

		// Get recording from storage
		await GetRecording();
		StateHasChanged();

		IsLoading = false;
		StateHasChanged();
	}

	private async Task GetRecording()
	{
		var recordings = await StorageService.GetRecordings();
		if (recordings.Count == 0)
		{
			NavigationManager.NavigateTo("/uploads");
		}

		var recording = recordings.FirstOrDefault(_ => _.Id == RecordingId);
		if (recording is null)
		{
			NavigationManager.NavigateTo("/uploads");
		}

		Recording = recording;
	}

	private void Close()
	{
		NavigationManager.NavigateTo($"/uploads/{RecordingId}");
	}
}